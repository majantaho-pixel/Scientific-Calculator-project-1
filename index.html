<!-- FULL ADVANCED VELOCITY SPEEDTEST WEBSITE -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Velocity Speed Test – Advanced</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<style>
  body { background: #070910; color: white; font-family: 'Inter', sans-serif; }
  .card-bg { background: #0f1320; border-radius: 22px; padding: 24px; box-shadow: 0 0 25px rgba(0,255,255,0.25), inset 0 0 18px rgba(0,255,255,0.15); border: 2px solid rgba(0,255,255,0.4); }
  .neon { box-shadow: 0 0 20px #00f6ff, inset 0 0 20px #00f6ff; border-color: #00f6ff; }
  button:hover { box-shadow: 0 0 12px #00f6ff, 0 0 24px #00f6ff inset; transition: 0.3s; }
  select, button { transition: 0.2s; }
</style>
</head>
<body class="p-4 flex justify-center items-center min-h-screen">

<div class="w-full max-w-2xl card-bg neon">
  <h2 class="text-center text-xl font-bold mb-5 tracking-wide text-cyan-300">VELOCITY ADVANCED SPEEDTEST</h2>

  <!-- Server Selection -->
  <div class="mb-4">
    <label class="text-sm text-gray-300">Choose Server:</label>
    <select id="serverSelect" class="w-full mt-1 p-2 bg-[#1a2035] rounded-lg">
      <option value="pk1">Pakistan – Lahore</option>
      <option value="pk2">Pakistan – Islamabad</option>
      <option value="in1">India – Mumbai</option>
      <option value="de1">Germany – Frankfurt</option>
      <option value="us1">USA – New York</option>
    </select>
  </div>

  <!-- Graph -->
  <canvas id="speedGraph" height="150" class="rounded-xl bg-[#101425]"></canvas>

  <!-- Outputs -->
  <div class="grid grid-cols-2 gap-4 mt-6">
    <div class="p-4 bg-[#1d2035] rounded-xl text-center">
      <p class="text-sm text-gray-400">Download</p>
      <p class="text-2xl font-bold" id="download">0.00</p>
    </div>
    <div class="p-4 bg-[#1d2035] rounded-xl text-center">
      <p class="text-sm text-gray-400">Upload</p>
      <p class="text-2xl font-bold" id="upload">0.00</p>
    </div>
  </div>
  <div class="grid grid-cols-2 gap-4 mt-6">
    <div class="p-4 bg-[#1d2035] rounded-xl text-center">
      <p class="text-sm text-gray-400">Ping</p>
      <p class="text-2xl font-bold" id="ping">--</p>
    </div>
    <div class="p-4 bg-[#1d2035] rounded-xl text-center">
      <p class="text-sm text-gray-400">Jitter</p>
      <p class="text-2xl font-bold" id="jitter">--</p>
    </div>
  </div>

  <!-- Buttons -->
  <div class="flex justify-center gap-3 mt-6">
    <button onclick="startSpeedtest()" class="px-6 py-3 bg-blue-500 hover:bg-blue-600 rounded-xl text-lg font-semibold shadow-lg">Start Test</button>
    <button onclick="shareResult()" class="px-6 py-3 bg-cyan-600 hover:bg-cyan-700 rounded-xl text-lg font-semibold shadow-lg">Share</button>
  </div>
  <div class="flex justify-center gap-3 mt-4">
    <button onclick="exportImage()" class="px-6 py-3 bg-purple-600 hover:bg-purple-700 rounded-xl text-lg font-semibold shadow-lg">Export</button>
    <button onclick="toggleAuto()" class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-xl text-lg font-semibold shadow-lg">Auto</button>
  </div>

  <footer class="text-center text-gray-400 mt-8">
    <p class="text-sm">© 2025 Velocity Speed Test</p>
    <p class="text-sm cursor-pointer">Privacy Policy • Terms of Service</p>
  </footer>
</div>

<script>
let autoMode = false;

// ============================
// Chart.js Graph Setup
// ============================
const ctx = document.getElementById('speedGraph').getContext('2d');
const speedChart = new Chart(ctx, {
  type: 'line',
  data: { labels: [], datasets: [{ label: 'Speed (Mbps)', data: [], borderColor: '#00f6ff', backgroundColor: 'rgba(0,246,255,0.2)', tension: 0.4 }] },
  options: { responsive:true, animation: { duration: 500 }, scales: { y: { beginAtZero: true } } }
});

function updateGraph(value) {
  const now = new Date().toLocaleTimeString();
  speedChart.data.labels.push(now);
  speedChart.data.datasets[0].data.push(value);
  if(speedChart.data.labels.length > 20) {
    speedChart.data.labels.shift();
    speedChart.data.datasets[0].data.shift();
  }
  speedChart.update();
}

// ============================
// Speedtest Functions
// ============================
async function startSpeedtest() {
  const server = document.getElementById("serverSelect").value;
  const downloadBox = document.getElementById("download");
  const uploadBox = document.getElementById("upload");
  const pingBox = document.getElementById("ping");
  const jitterBox = document.getElementById("jitter");

  downloadBox.innerText = "0.00"; 
  uploadBox.innerText = "0.00";
  pingBox.innerText = "--"; 
  jitterBox.innerText = "--";

  try {
    // Backend GET: ping + download
    const data = await fetch(`http://localhost:3000/api/speedtest?server=${server}`)
      .then(res => res.json());

    downloadBox.innerText = data.download;
    pingBox.innerText = data.ping;
    updateGraph(data.download);

    // Jitter (simulate small variation)
    jitterBox.innerText = Math.floor(Math.random() * 10) + 1;

    // Backend POST: upload
    const uploadData = new Uint8Array(2*1024*1024);
    const uploadResult = await fetch('http://localhost:3000/api/upload', {
      method: 'POST',
      body: uploadData
    }).then(res => res.json());

    uploadBox.innerText = uploadResult.upload;
    updateGraph(uploadResult.upload);

    speakResult(`Download ${data.download} Mbps, Upload ${uploadResult.upload} Mbps`);

  } catch(err) {
    console.error(err);
    alert("Backend not reachable! Make sure Node.js server is running.");
  }
}

// ============================
// Voice Output
// ============================
function speakResult(text){
  const synth = window.speechSynthesis;
  const utter = new SpeechSynthesisUtterance(text);
  utter.rate = 1;
  synth.speak(utter);
}

// ============================
// Auto Mode
// ============================
function toggleAuto(){
  autoMode = !autoMode;
  if(autoMode) runAuto();
}
async function runAuto(){
  while(autoMode){
    await startSpeedtest();
    await new Promise(r=>setTimeout(r,5000));
  }
}

// ============================
// Export Image
// ============================
function exportImage(){
  html2canvas(document.querySelector('.card-bg')).then(canvas=>{
    const link = document.createElement('a');
    link.download = 'speedtest.png';
    link.href = canvas.toDataURL();
    link.click();
  });
}

// ============================
// Share Placeholder
// ============================
function shareResult(){
  alert("Sharing feature placeholder. Implement with Web Share API or backend.");
}
</script>

</body>
</html>
